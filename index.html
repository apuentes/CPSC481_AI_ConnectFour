<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
    <!--<script src="./phaser.min.js"></script>-->
</head>
<body>

    <script>
    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 200 }
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var pPieces = [];
    var aiPieces = [];
                /* Column X Coords
            242-262  Col 1
            296-313  Col 2
            349-366  Col 3
            405-415  Col 4
            457-470  Col 5
            507-521  Col 6
            560-576  Col 7

            */
    var pieceColLoc = [242,296,349,400,452,505,558];
    var pieceRowLoc = [430,373,320,263,208,153];
    var board = [[0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0]];
    var pPieceCol = 0;
    var player = 1;
    var keyReleased;
    var addPiece;
    var game = new Phaser.Game(config);


    function preload ()
    {

        this.load.image('board', 'assets/c4Board.png');
        this.load.image('red', 'assets/redPiece.png');
        this.load.image('yellow', 'assets/yellPiece.png');

    }

    function create ()
    {
        this.left = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT);
        this.right = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT);
        this.enter = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);


        //create game pieces
        for (let i=0; i<42; i++)
        {
            pPieces.push(this.add.sprite(242,-50, 'red').setScale(.5));
            aiPieces.push(this.add.sprite(242,-50, 'yellow').setScale(.5));
        }

        this.pPosPiece = this.add.sprite(242, 528, 'red').setScale(.5);
        var pointer = this.input.activePointer;
        var gameBoard = this.add.image(400, 300, 'board');
        gameBoard.setScale(1.5);
        console.log(game.input.x+" "+game.input.y);
        this.posY = 0;


    }

    function clearBoard()
    {
        //TODO create a clear board function that pours the pieces down the bottom
        // and bounce out of scene

    }

    //TODO pass in player
    function isWinner()
    {
        //Check for horizontal winner
        let consec = 0;
        for (let i=0; i<=5; i++)
        {
            for (let j=0; j<=6; j++)
            {
                if (board[i][j]==player)
                {
                    consec = consec +1;
                    if (consec==4)
                    {
                        return true;
                    }
                }
                else if(board[i][j]==0)
                {
                    consec = 0;
                }
            }
 
        }
        //Check for vertical winner
        consec = 0;
        for (let i=0; i<3; i++)
        {
            if (board[i][pPieceCol]==player)
            {
                consec = consec+1;
                if (consec==4)
                {
                    return true;
                }
            }
            else
            {
                    consec = 0;
            }
        }
        //Check positive slope winner
        for (let i=0; i<3; i++)
        {
            for (let j=0; j<4; j++)
            {
                if (board[i][j]==player && board[i+1][j+1]==player && board[i+2][j+2]==player && board[i+3][j+3]==player)
                {
                    return true;
                }
            }
         }
        //Check negative slope winner
        for (let i=5; i>2; i--)
        {
            for (let j=0; j<4; j++)
            {
                if (board[i][j]==player && board[i-1][j+1]==player && board[i-2][j+2]==player && board[i-3][j+3]==player)
                {
                    return true;
                }
            }
         }
        player = -player;
        return false;

    }

    function update()
    {
        
        if (addPiece)
        {
            if (newPlayerPiece.y < row)
            {
                newPlayerPiece.y = newPlayerPiece.y +10;
            }
            else if (newPlayerPiece.y >= row)
            {

                if(isWinner())
                {
                    console.log("Player "+player+"is the WIENER!!!!");
                }
                addPiece = false;
            }
        }

        if (this.left.isDown)
        {
            if (this.keyReleased==true)
            {
                for (let i=0; i<=6; i++)
                {
                    if(this.pPosPiece.x == pieceColLoc[i] && i >0)
                    {
                        this.pPosPiece.x = pieceColLoc[i-1];
                        pPieceCol = i-1;
                        break;
                    }
                }
                this.keyReleased = false;
            }
        }
        else if (this.right.isDown)
        {
            if (this.keyReleased==true)
            {
                for (let i=0; i<6; i++){
                    if(this.pPosPiece.x == pieceColLoc[i] && i <6)
                    {
                        this.pPosPiece.x = pieceColLoc[i+1];
                        pPieceCol = i+1;
                        break;
                    }
                }
                this.keyReleased = false;
            }
        }
        else if (this.enter.isDown)
        {
            
            if (this.keyReleased==true)
            {
                for (let i=0; i<=5; i++)
                {
                    if (board[i][pPieceCol] == 0)
                    {
                        row = pieceRowLoc[i];
                        board[i][pPieceCol] = player;
                        console.log(board);
                        break;
                    }
                }
                if (player)
                {
                    console.log("Inside "+player+" piece to choose");
                    newPlayerPiece = pPieces.pop();
                    console.log(newPlayerPiece);
                }
                else
                {
                    console.log("Inside "+player+" piece to choose");
                    newPlayerPiece = aiPieces[0];
                    console.log(newPlayerPiece);
                    
                }
                newPlayerPiece.x = this.pPosPiece.x;

                addPiece = true;
            }
            this.keyReleased = false;
        }
        else if (this.left.isUp && 
                this.right.isUp && 
                this.enter.isUp &&
                !addPiece)
        {
            this.keyReleased = true;
        }

         
    }
    </script>
    <!--<script type="module" src="./phaser/dist/phaser.js" charset="utf-8"></script>-->
</body>
</html>
